{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Campus Map | Uni360</title>
  <link rel="stylesheet" href="{% static 'pos/style.css' %}">
  <link rel="stylesheet" href="{% static 'pos/map.css' %}">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet Routing Machine CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
</head>
<body>
  <div class="sidebar">
    <div>
      <h2 style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 24px;">üéì</span>
        <span>Uni360</span>
      </h2>
      <a href="{% url 'dashboard' %}">üè† Dashboard</a>
      <a href="{% url 'map' %}" class="active">üó∫Ô∏è Campus Map</a>
      <a href="{% url 'safety' %}">üõ°Ô∏è Safety</a>
      <a href="{% url 'notifications' %}">üîî Notifications <span id="unread-badge" style="display: none; background: #ff4444; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; margin-left: 5px;">0</span></a>
    </div>
    <a href="{% url 'logout' %}" class="logout">Logout</a>
  </div>

  <!-- Top Header -->
  <div class="top-header">
    <div class="search-bar">
      <input type="text" id="search-input" placeholder="Search buildings...">
      <button onclick="searchBuilding()">Searchüîç</button>
    </div>
    <div class="profile-menu">
      <a href="{% url 'profile' %}">
        <img src="{% if user.profile.profile_picture %}{{ user.profile.profile_picture.url }}{% else %}{% static 'pos/default-profile.jpg' %}{% endif %}" alt="User Profile Image" class="profile-icon" role="button" tabindex="0" aria-label="Go to profile">
      </a>
    </div>
  </div>

  <div class="content">
    <h1>Campus Navigation üó∫Ô∏è</h1>
    <p>Explore the university campus interactively.</p>
    
    <!-- Controls Panel -->
    <div class="controls-panel">
      <div class="route-controls">
        <select id="start-location">
          <option value="">Select starting point...</option>
          <option value="current">üìç My Current Location</option>
        </select>
        <select id="end-location">
          <option value="">Select destination...</option>
        </select>
        <button onclick="calculateRoute()">üö∂ Get Directions</button>
        <button onclick="clearRoute()">‚úñÔ∏è Clear Route</button>
      </div>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Building Info Panel -->
    <div class="building-info" id="building-info" style="display: none;">
      <h3 id="building-name"></h3>
      <p id="building-description"></p>
      <button onclick="setAsDestination()" class="btn-primary">Set as Destination</button>
    </div>

    <!-- Directions Panel -->
    <div class="directions-panel" id="directions-panel">
      <h4>üìç Recent Routes</h4>
      <div id="directions-steps"></div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Leaflet Routing Machine -->
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <script>
    // CIT-U Campus buildings
    const buildings = [
      {
        name: "NGE Building",
        description: "Administration and main classrooms",
        latitude: 10.2944,
        longitude: 123.8811,
        color: "#6610F2",
      },
      {
        name: "GLE Building",
        description: "Administration and main classrooms",
        latitude: 10.2953,
        longitude: 123.8812,
        color: "#6610F2",
      },
      {
        name: "ACAD Building",
        description: "Administration and main classrooms",
        latitude: 10.29575,
        longitude: 123.8810,
        color: "#6610F2",
      },
      {
        name: "RTL Building",
        description: "Administration and main classrooms",
        latitude: 10.2948,
        longitude: 123.8801,
        color: "#6610F2",
      },
      {
        name: "RTL Building",
        description: "Administration and main classrooms",
        latitude: 10.2949,
        longitude: 123.8809,
        color: "#6610F2",
      },
      {
        name: "SAL Building",
        description: "Administration and main classrooms",
        latitude: 10.2954,
        longitude: 123.8800,
        color: "#6610F2",
      },
      {
        name: "ALLIED 1st Building Building",
        description: "Administration and main classrooms",
        latitude: 10.2958,
        longitude: 123.8795,
        color: "#6610F2",
      },
      {
        name: "ALLIED 2nd Building",
        description: "Administration and main classrooms",
        latitude: 10.2953,
        longitude: 123.8797,
        color: "#6610F2",
      },
      {
        name: "ALLIED 3rd Building",
        description: "Administration and main classrooms",
        latitude: 10.2947,
        longitude: 123.8799,
        color: "#6610F2",
      },
      {
        name: "Library",
        description: "Main campus library with study areas",
        latitude: 10.29527,
        longitude: 123.88078,
        color: "#2EC4B6",
        type: "library"
      },
      {
        name: "Main Canteen",
        description: "Cafeteria and student activities",
        latitude: 10.29619,
        longitude: 123.8805,
        color: "#FF6B6B",
        type: "cafeteria"
      },
      {
        name: "GYM Canteen",
        description: "Cafeteria and student activities",
        latitude: 10.2965,
        longitude: 123.8798,
        color: "#FF6B6B",
        type: "cafeteria"
      },
      {
        name: "Gymnasium",
        description: "Sports facilities and gym",
        latitude: 10.2963,
        longitude: 123.8795,
        color: "#E71D36",
        type: "sports"
      },
      {
        name: "NGE Parking Area",
        description: "Student and faculty parking",
        latitude: 10.2944,
        longitude: 123.8805,
        color: "#7B68EE",
        type: "parking"
      },
      {
        name: "RTL Parking Area",
        description: "Student and faculty parking",
        latitude: 10.2947,
        longitude: 123.8805,
        color: "#7B68EE",
        type: "parking"
      },
      {
        name: "GLE Parking Area",
        description: "Student and faculty parking",
        latitude: 10.2952,
        longitude: 123.8810,
        color: "#7B68EE",
        type: "parking"
      },
      {
        name: "Espacio Parking Area",
        description: "Student and faculty parking",
        latitude: 10.2958,
        longitude: 123.8805,
        color: "#7B68EE",
        type: "parking"
      },
      {
        name: "Back Gate Parking Area",
        description: "Student and faculty parking",
        latitude: 10.2968,
        longitude: 123.8800,
        color: "#7B68EE",
        type: "parking"
      }
      
    ];

    // Building type to icon mapping
    const buildingIcons = {
      'library': 'üìö',
      'cafeteria': 'üçΩÔ∏è',
      'sports': '‚öΩ',
      'lab': 'üíª',
      'parking': 'üÖøÔ∏è',
      'default': 'üè¢'
    };

    let map;
    let markers = [];
    let selectedBuilding = null;
    let routingControl = null;
    let userMarker = null;
    let routeHistory = JSON.parse(localStorage.getItem('routeHistory')) || [];

    // Initialize the map
    function initMap() {
      // Create map centered on CIT-U
      map = L.map('map').setView([10.2950, 123.8810], 17.5);

      // Add OpenStreetMap tiles (FREE!)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      // Populate building selects
      populateBuildingSelects();

      // Add building markers
      addBuildingMarkers();

      // Try to get user location
      getUserLocation();

      // Check for selected route from dashboard
      const selectedRoute = JSON.parse(localStorage.getItem('selectedRoute'));
      if (selectedRoute) {
        localStorage.removeItem('selectedRoute');
        document.getElementById('start-location').value = selectedRoute.start;
        document.getElementById('end-location').value = selectedRoute.end;
        setTimeout(() => calculateRoute(), 1000); // Delay to ensure map is loaded
      }
    }

    // Add markers for all buildings
    function addBuildingMarkers() {
      buildings.forEach(building => {
        // Get appropriate icon for building type
        const icon = buildingIcons[building.type] || buildingIcons.default;
        
        // Create custom colored marker
        const customIcon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="background: ${building.color}; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); font-size: 16px;">${icon}</div>`,
          iconSize: [35, 35]
        });

        const marker = L.marker([building.latitude, building.longitude], {
          icon: customIcon
        }).addTo(map);

        // Add popup
        marker.bindPopup(`
          <div style="min-width: 200px;">
            <h3 style="color: ${building.color}; margin: 0 0 8px 0;">${building.name}</h3>
            <p style="margin: 0 0 10px 0; color: #666;">${building.description}</p>
            <button onclick="setBuildingAsDestination('${building.name}')" 
                    style="background: linear-gradient(90deg, #6610F2, #2EC4B6); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 600; width: 100%;">
              Get Directions üö∂
            </button>
          </div>
        `);

        // Show building info when clicked
        marker.on('click', () => {
          showBuildingInfo(building);
          selectedBuilding = building;
        });

        markers.push(marker);
      });
    }

    // Show building information in the side panel
    function showBuildingInfo(building) {
      document.getElementById('building-name').textContent = building.name;
      document.getElementById('building-description').textContent = building.description;
      document.getElementById('building-info').style.display = 'block';
    }

    // Populate dropdown selects with building options
    function populateBuildingSelects() {
      const startSelect = document.getElementById('start-location');
      const endSelect = document.getElementById('end-location');

      const uniqueNames = [...new Set(buildings.map(b => b.name))];

      uniqueNames.forEach(name => {
        const startOption = new Option(name, name);
        const endOption = new Option(name, name);

        startSelect.add(startOption);
        endSelect.add(endOption);
      });
    }

    // Set building as destination from popup
    window.setBuildingAsDestination = function(buildingName) {
      document.getElementById('end-location').value = buildingName;
      calculateRoute();
    }

    // Set selected building as destination
    function setAsDestination() {
      if (selectedBuilding) {
        document.getElementById('end-location').value = selectedBuilding.name;
        calculateRoute();
      }
    }

    // Calculate route between selected locations
    function calculateRoute() {
      const start = document.getElementById('start-location').value;
      const end = document.getElementById('end-location').value;
      
      if (!start || !end) {
        alert('Please select both starting point and destination.');
        return;
      }

      if (start === end) {
        alert('Starting point and destination cannot be the same!');
        return;
      }

      // Remove existing route
      if (routingControl) {
        map.removeControl(routingControl);
      }

      let startCoords;
      
      if (start === 'current') {
        // Use user's current location
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            position => {
              startCoords = [position.coords.latitude, position.coords.longitude];
              
              // Add or update user marker
              if (userMarker) {
                userMarker.setLatLng(startCoords);
              } else {
                userMarker = L.marker(startCoords, {
                  icon: L.divIcon({
                    html: 'üìç',
                    className: 'user-marker',
                    iconSize: [30, 30]
                  })
                }).addTo(map).bindPopup('You are here!');
              }
              
              calculateRouteWithCoords(startCoords, end, start);
            },
            () => {
              alert('Unable to get your location. Please select a building as starting point.');
            }
          );
          return;
        }
      } else {
        // Find building coordinates
        const startBuilding = buildings.find(b => b.name === start);
        if (startBuilding) {
          startCoords = [startBuilding.latitude, startBuilding.longitude];
          calculateRouteWithCoords(startCoords, end, start);
        }
      }
    }

    // Calculate route with specific coordinates
    function calculateRouteWithCoords(startCoords, endName, startName) {
      const matchingBuildings = buildings.filter(b => b.name === endName);
      if (matchingBuildings.length === 0) {
        alert('Destination building not found.');
        return;
      }

      // Find the closest building to the start
      let closestBuilding = matchingBuildings[0];
      let minDistance = Infinity;
      matchingBuildings.forEach(building => {
        const distance = map.distance(L.latLng(startCoords), L.latLng(building.latitude, building.longitude));
        if (distance < minDistance) {
          minDistance = distance;
          closestBuilding = building;
        }
      });

      const endCoords = [closestBuilding.latitude, closestBuilding.longitude];

      // Remove existing route
      if (routingControl) {
        map.removeControl(routingControl);
      }

      // Create routing control with OSRM
      routingControl = L.Routing.control({
        waypoints: [
          L.latLng(startCoords),
          L.latLng(endCoords)
        ],
        router: L.Routing.osrmv1({
          serviceUrl: 'https://router.project-osrm.org/route/v1'
        }),
        routeWhileDragging: false,
        addWaypoints: false,
        showAlternatives: false,
        fitSelectedRoutes: true,
        lineOptions: {
          styles: [
            { 
              color: '#6610F2', 
              opacity: 0.8, 
              weight: 6,
              className: 'route-line'
            }
          ]
        },
        createMarker: function(i, waypoint, n) {
          if (i === 0 && startCoords[0] !== waypoint.latLng.lat) {
            // This is the user's current location
            const icon = L.divIcon({
              html: 'üö∂',
              className: 'route-marker start-marker',
              iconSize: [30, 30]
            });
            return L.marker(waypoint.latLng, {icon: icon}).bindPopup('Start Point');
          } else {
            // This is a building
            const icon = L.divIcon({
              html: i === 0 ? 'üö∂' : 'üìç',
              className: 'route-marker',
              iconSize: [30, 30]
            });
            return L.marker(waypoint.latLng, {icon: icon}).bindPopup(i === 0 ? 'Start' : 'Destination');
          }
        }
      }).addTo(map);

      // Handle route events
      routingControl.on('routesfound', function(e) {
        const routes = e.routes;
        const route = routes[0];

        // Add to history
        routeHistory.unshift({
          start: startName,
          end: endName,
          distance: route.summary.totalDistance,
          time: route.summary.totalTime
        });
        // Keep only last 5
        if (routeHistory.length > 5) routeHistory.pop();

        // Save to localStorage
        localStorage.setItem('routeHistory', JSON.stringify(routeHistory));

        // Display history in the panel
        displayHistory();

        // Show directions panel
        document.getElementById('directions-panel').style.display = 'block';
      });

      routingControl.on('routingerror', function(e) {
        console.error('Routing error:', e.error);
        alert('Unable to calculate route. Please try again.');
      });
    }

    // Recalculate a route from history
    function recalculateRoute(start, end) {
      document.getElementById('start-location').value = start;
      document.getElementById('end-location').value = end;
      calculateRoute();
    }

    // Display route history
    function displayHistory() {
      const directionsElement = document.getElementById('directions-steps');

      if (routeHistory.length === 0) {
        directionsElement.innerHTML = '<p>No recent routes.</p>';
        return;
      }

      let historyHTML = '<div class="history-list">';

      routeHistory.forEach((item, index) => {
        const distanceKm = (item.distance / 1000).toFixed(1);
        const timeMin = Math.round(item.time / 60);
        historyHTML += `
          <div class="history-item" onclick="recalculateRoute('${item.start}', '${item.end}')">
            <div class="history-route">${item.start} ‚Üí ${item.end}</div>
            <div class="history-details">${distanceKm} km ‚Ä¢ ${timeMin} min</div>
          </div>
        `;
      });

      historyHTML += '</div>';

      directionsElement.innerHTML = historyHTML;
    }

    // Get appropriate icon for direction type
    function getDirectionIcon(step) {
      const text = step.text.toLowerCase();
      if (text.includes('left')) return '‚Ü∞';
      if (text.includes('right')) return '‚Ü±';
      if (text.includes('straight')) return '‚Üë';
      if (text.includes('arrive')) return 'üìç';
      if (text.includes('head') || text.includes('start')) return 'üö∂';
      if (text.includes('roundabout')) return 'üîÑ';
      return '‚Ä¢';
    }

    // Clear current route
    function clearRoute() {
      if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
      }
      
      // Clear any custom route layers
      map.eachLayer(layer => {
        if (layer instanceof L.Polyline) {
          map.removeLayer(layer);
        }
      });
      
      // Keep history panel visible
      document.getElementById('building-info').style.display = 'none';
      
      // Reset dropdowns but keep "current location" option
      const startSelect = document.getElementById('start-location');
      const endSelect = document.getElementById('end-location');
      endSelect.value = '';
      if (startSelect.value !== 'current') {
        startSelect.value = '';
      }
    }

    // Search for buildings
    function searchBuilding() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const building = buildings.find(b => 
        b.name.toLowerCase().includes(searchTerm) || 
        b.description.toLowerCase().includes(searchTerm)
      );
      
      if (building) {
        map.setView([building.latitude, building.longitude], 19);
        showBuildingInfo(building);
        selectedBuilding = building;
        
        // Open the marker's popup
        markers.forEach(marker => {
          const markerLatLng = marker.getLatLng();
          if (markerLatLng.lat === building.latitude && markerLatLng.lng === building.longitude) {
            marker.openPopup();
          }
        });
      } else {
        alert('Building not found. Please try another search term.');
      }
    }

    // Get user's current location
    function getUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const userCoords = [position.coords.latitude, position.coords.longitude];
            
            userMarker = L.marker(userCoords, {
              icon: L.divIcon({
                html: 'üìç',
                className: 'user-marker',
                iconSize: [30, 30]
              })
            }).addTo(map).bindPopup('You are here!');
          },
          error => {
            console.log('Geolocation not available or permission denied');
          }
        );
      }
    }

    // Initialize map when page loads
    window.onload = initMap;
  </script>
</body>
</html>
