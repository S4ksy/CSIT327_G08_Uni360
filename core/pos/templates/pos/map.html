{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Campus Map | Uni360</title>
  <link rel="stylesheet" href="{% static 'pos/style.css' %}">
  <link rel="stylesheet" href="{% static 'pos/map.css' %}">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet Routing Machine CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

</head>
<body>
<div class="sidebar">
  <div>
    <h2 style="display: flex; align-items: center; gap: 10px;">
      <span style="font-size: 24px;">üéì</span>
      <span>Uni360</span>
    </h2>
    <div class="user-profile">
      <img src="{% if user.profile.profile_picture_data %}{{ user.profile.profile_picture_data }}{% else %}{% static 'pos/default-profile.jpg' %}{% endif %}" alt="Profile Picture" class="sidebar-profile-pic" style="width: 40px !important; height: 40px !important; max-width: 40px !important; max-height: 40px !important; object-fit: cover !important;">
      <span class="user-name">{{ request.user.profile.full_name|default:request.user.username }}</span>
    </div>
    <a href="{% url 'dashboard' %}">Dashboard</a>
      <a href="{% url 'map' %}" class="active">Campus Map</a>
      <a href="{% url 'safety' %}">Safety</a>
      <a href="{% url 'notifications' %}">Notifications</a>
      <a href="{% url 'profile' %}">Profile</a>
    </div>
    <a href="{% url 'logout' %}" class="logout">Logout</a>
  </div>


  <div class="content">
    <h1>Campus Navigation</h1>
    <p>Explore the university campus interactively.</p>
    
    <!-- Controls Panel -->
    <div class="controls-panel">
      <div class="route-controls">
        <select id="start-location">
          <option value="">Select starting point...</option>
          <option value="current">üìç My Current Location</option>
        </select>
        <select id="end-location">
          <option value="">Select destination...</option>
        </select>
        <button id="calculate-route-btn" onclick="calculateRoute()" disabled>Get Directions</button>
        <button onclick="clearRoute()">Clear Route</button>
      </div>
      <div class="share-location-controls" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
        <button onclick="openShareLocationModal()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 10px;">Share Location</button>
      </div>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Building Info Panel -->
    <div class="building-info" id="building-info" style="display: none;">
      <h3 id="building-name"></h3>
      <p id="building-description"></p>
      <button onclick="setAsDestination()" class="btn-primary">Set as Destination</button>
    </div>
    
    <!-- Recent Routes shown under the map - FORCE LEFT ALIGNMENT -->
    <div id="recent-routes-section" class="recent-routes-section"
         style="margin-left: 0; margin-right: auto; padding-left: 0; width: 100%; text-align: left; margin-top: 30px; display: none;">
      <div class="recent-routes-header">
        <h3>üìç Recent Routes</h3>
        <div class="recent-routes-actions">
          <button id="clear-history" class="clear-history" title="Clear recent routes">Clear</button>
        </div>
      </div>
      <div id="recent-routes" class="recent-routes" aria-live="polite"
           style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: flex-start; margin-left: 0; margin-right: auto;">
        <!-- Filled by displayHistory() -->
      </div>
      <div id="recent-routes-footer" class="recent-routes-footer" style="margin-top: 20px; display: flex; justify-content: flex-start;">
        <button id="show-more-btn" class="show-more" style="display:none">Show more</button>
      </div>
    </div>
  </div>

  <!-- Share Location Modal -->
  <div id="share-location-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; color: #333; padding: 20px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
      {% csrf_token %}
      <h3 style="margin: 0 0 15px 0; color: #333;">üìç Share Your Location</h3>
      <p style="margin: 0 0 15px 0; color: #666;">Select users to share your current location with:</p>

      <div style="margin-bottom: 15px;">
        <input type="text" id="user-search" placeholder="Search users..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
      </div>
      <div id="users-list" style="margin-bottom: 20px; max-height: 200px; overflow-y: auto;">
        <!-- Users will be loaded here -->
      </div>

      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button onclick="closeShareLocationModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Cancel</button>
        <button onclick="shareLocation()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">Share Location</button>
      </div>
    </div>
  </div>

  <!-- Location Shared Success Modal -->
  <div id="location-shared-success-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; justify-content: center; align-items: center;">
    <div style="background: white; color: #333; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
      <div style="font-size: 48px; margin-bottom: 20px;">‚úÖ</div>
      <h3 style="margin: 0 0 15px 0; color: #28a745;">Location Shared Successfully!</h3>
      <p style="margin: 0 0 25px 0; color: #666;">Your location has been shared with the selected users.</p>
      <button onclick="closeLocationSharedSuccessModal()" style="background: #28a745; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">OK</button>
    </div>
  </div>

  <!-- Delete Route Confirmation Modal -->
  <div id="delete-route-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1002; justify-content: center; align-items: center;">
    <div style="background: white; color: #333; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
      <div style="font-size: 48px; margin-bottom: 20px;">üóëÔ∏è</div>
      <h3 style="margin: 0 0 15px 0; color: #dc3545;">Delete Recent Route?</h3>
      <p style="margin: 0 0 25px 0; color: #666;">This action cannot be undone. Are you sure you want to delete this recent route?</p>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button onclick="closeDeleteRouteModal()" style="background: #6c757d; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
        <button onclick="confirmDeleteRoute()" style="background: #dc3545; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 600;">Delete</button>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Leaflet Routing Machine -->
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <script>
   // Current user info
   const currentUserId = "{{ request.user.id }}";
   const currentUsername = "{{ request.user.username }}";

   // CIT-U Campus buildings
    const buildings = [
       { name: "NGE Building", description: "Administration and main classrooms", latitude: 10.2944, longitude: 123.8811, color: "#6610F2" },
       { name: "GLE Building", description: "Administration and main classrooms", latitude: 10.2953, longitude: 123.8812, color: "#6610F2" },
       { name: "ACAD Building", description: "Administration and main classrooms", latitude: 10.29575, longitude: 123.8810, color: "#6610F2" },
       { name: "RTL Building", description: "Administration and main classrooms", latitude: 10.2948, longitude: 123.8801, color: "#6610F2" },
       { name: "RTL Building", description: "Administration and main classrooms", latitude: 10.2949, longitude: 123.8809, color: "#6610F2" },
       { name: "SAL Building", description: "Administration and main classrooms", latitude: 10.2954, longitude: 123.8800, color: "#6610F2" },
       { name: "ALLIED 1st Building", description: "Administration and main classrooms", latitude: 10.2958, longitude: 123.8795, color: "#6610F2" },
       { name: "ALLIED 2nd Building", description: "Administration and main classrooms", latitude: 10.2953, longitude: 123.8797, color: "#6610F2" },
       { name: "ALLIED 3rd Building", description: "Administration and main classrooms", latitude: 10.2947, longitude: 123.8799, color: "#6610F2" },
       { name: "Library", description: "Main campus library with study areas", latitude: 10.29527, longitude: 123.88078, color: "#2EC4B6", type: "library" },
       { name: "Main Canteen", description: "Cafeteria and student activities", latitude: 10.29619, longitude: 123.8805, color: "#FF6B6B", type: "cafeteria" },
       { name: "GYM Canteen", description: "Cafeteria and student activities", latitude: 10.2965, longitude: 123.8798, color: "#FF6B6B", type: "cafeteria" },
       { name: "Gymnasium", description: "Sports facilities and gym", latitude: 10.2963, longitude: 123.8795, color: "#E71D36", type: "sports" },
       { name: "NGE Parking Area", description: "Student and faculty parking", latitude: 10.2944, longitude: 123.8805, color: "#7B68EE", type: "parking" },
       { name: "RTL Parking Area", description: "Student and faculty parking", latitude: 10.2947, longitude: 123.8805, color: "#7B68EE", type: "parking" },
       { name: "GLE Parking Area", description: "Student and faculty parking", latitude: 10.2952, longitude: 123.8810, color: "#7B68EE", type: "parking" },
       { name: "Espacio Parking Area", description: "Student and faculty parking", latitude: 10.2958, longitude: 123.8805, color: "#7B68EE", type: "parking" },
       { name: "Back Gate Parking Area", description: "Student and faculty parking", latitude: 10.2968, longitude: 123.8800, color: "#7B68EE", type: "parking" }
     ];

    // Building type to icon mapping
    const buildingIcons = {
      'library': 'üìö',
      'cafeteria': 'üçΩÔ∏è',
      'sports': '‚öΩ',
      'lab': 'üíª',
      'parking': 'üÖøÔ∏è',
      'default': 'üè¢'
    };

    let map;
    let markers = [];
    let selectedBuilding = null;
    let routingControl = null;
    let userMarker = null;
    let routeHistory = [];
    let routeToDeleteIndex = null;

    // Helper functions to get user-specific localStorage keys
    function getRouteHistoryKey() {
      return `routeHistory_${currentUserId}`;
    }

    function getSelectedRouteKey() {
      return `selectedRoute_${currentUserId}`;
    }

    // Layers we manage
    let routeLayer = null;          // polyline for the currently drawn route
    let routeMarkers = [];          // markers placed for the route (start/end)
    
    // Haversine distance (meters)
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) ** 2 +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function initMap() {
      // Load user-specific route history
      routeHistory = JSON.parse(localStorage.getItem(getRouteHistoryKey())) || [];

      // Check if we have shared location parameters
      const sharedLat = "{{ shared_lat|default:'' }}";
      const sharedLng = "{{ shared_lng|default:'' }}";
      const sharedName = "{{ shared_name|default:'' }}";

      let initialLat = 10.2950;
      let initialLng = 123.8810;
      let initialZoom = 17.5;

      if (sharedLat && sharedLng) {
        initialLat = parseFloat(sharedLat);
        initialLng = parseFloat(sharedLng);
        initialZoom = 19; // Zoom in closer for shared location
      }

      map = L.map('map').setView([initialLat, initialLng], initialZoom);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      populateBuildingSelects();
      addBuildingMarkers();
      getUserLocation();
      displayHistory();

      // Enable routing button immediately
      document.getElementById('calculate-route-btn').disabled = false;

      // Add marker for shared location if present
      if (sharedLat && sharedLng) {
        const popupText = sharedName ? `Shared Location by ${sharedName}` : 'Shared Location';
        const sharedMarker = L.marker([initialLat, initialLng], {
          icon: L.divIcon({
            html: 'üìç',
            className: 'shared-location-marker',
            iconSize: [30, 30]
          })
        }).addTo(map).bindPopup(popupText).openPopup();
      }

      // Restore selectedRoute if dashboard pushed one
      const selectedRoute = JSON.parse(localStorage.getItem(getSelectedRouteKey()));
      if (selectedRoute) {
        localStorage.removeItem(getSelectedRouteKey());
        document.getElementById('start-location').value = selectedRoute.start;
        document.getElementById('end-location').value = selectedRoute.end;
        setTimeout(() => calculateRoute(), 800);
      }
    }

    function addBuildingMarkers() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      buildings.forEach((building, index) => {
        // Skip building, parking, canteen, library, and gym icons
        if (!building.type || building.type === 'parking' || building.type === 'cafeteria' || building.type === 'library' || building.type === 'sports') {
          return;
        }

        const icon = buildingIcons[building.type] || buildingIcons.default;
        const customIcon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="background: ${building.color}; color: whita; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); font-size: 16px;">${icon}</div>`,
          iconSize: [35, 35]
        });

        // Use JSON.stringify to safely inject the building name into inline onclick
        const safeName = JSON.stringify(building.name);

        const popupHtml = `
          <div style="min-width: 200px;">
            <h3 style="color: ${building.color}; margin: 0 0 8px 0;">${building.name}</h3>
            <p style="margin: 0 0 10px 0; color: #666;">${building.description}</p>
            <button onclick="setBuildingAsDestination(${safeName})"
              style="background: #6610F2; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 600; width: 100%;">
              Get Directions üö∂
            </button>
          </div>
        `;

        const marker = L.marker([building.latitude, building.longitude], { icon: customIcon }).addTo(map);
        marker.bindPopup(popupHtml);

        marker.on('click', () => {
          showBuildingInfo(building);
          selectedBuilding = building;
        });

        markers.push(marker);
      });
    }

    function showBuildingInfo(building) {
      document.getElementById('building-name').textContent = building.name;
      document.getElementById('building-description').textContent = building.description;
      document.getElementById('building-info').style.display = 'block';
    }

    function populateBuildingSelects() {
      const startSelect = document.getElementById('start-location');
      const endSelect = document.getElementById('end-location');

      const uniqueNames = [...new Set(buildings.map(b => b.name))];

      uniqueNames.forEach(name => {
        const startOption = new Option(name, name);
        const endOption = new Option(name, name);
        startSelect.add(startOption);
        endSelect.add(endOption);
      });
    }

    // Called from popup button
    window.setBuildingAsDestination = function(buildingName) {
      document.getElementById('end-location').value = buildingName;
      calculateRoute();
    }

    function setAsDestination() {
      if (selectedBuilding) {
        document.getElementById('end-location').value = selectedBuilding.name;
        calculateRoute();
      }
    }

    function calculateRoute() {
      const start = document.getElementById('start-location').value;
      const end = document.getElementById('end-location').value;

      if (!start || !end) { alert('Please select both starting point and destination.'); return; }
      if (start === end) { alert('Starting point and destination cannot be the same!'); return; }

      // Remove previous route visuals
      clearRoute(false); // keep dropdowns if needed

      if (start === 'current') {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(position => {
            const startCoords = [position.coords.latitude, position.coords.longitude];
            if (userMarker) {
              userMarker.setLatLng(startCoords);
            } else {
              userMarker = L.marker(startCoords, {
                icon: L.divIcon({ html: 'üìç', className: 'user-marker', iconSize: [30, 30] })
              }).addTo(map).bindPopup('You are here!');
            }
            calculateRouteWithCoords(startCoords, end, start);
          }, () => alert('Unable to get your location. Please select a building as starting point.'));
          return;
        } else {
          alert('Geolocation not supported by your browser.');
          return;
        }
      } else {
        const startBuilding = buildings.find(b => b.name === start);
        if (startBuilding) {
          const startCoords = [startBuilding.latitude, startBuilding.longitude];
          calculateRouteWithCoords(startCoords, end, start);
        } else {
          alert('Starting building not found.');
        }
      }
    }

    function calculateRouteBetweenPoints(startCoords, endCoords) {
      // Use Leaflet Routing Machine for road-based routing
      if (routingControl) {
        map.removeControl(routingControl);
      }

      routingControl = L.Routing.control({
        waypoints: [
          L.latLng(startCoords[0], startCoords[1]),
          L.latLng(endCoords[0], endCoords[1])
        ],
        routeWhileDragging: false,
        createMarker: function() { return null; }, // We'll add our own markers
        lineOptions: {
          styles: [{ color: '#6610F2', opacity: 0.9, weight: 6 }]
        }
      }).addTo(map);

      return []; // Routing control handles the display
    }

    function calculateRouteWithCoords(startCoords, endName, startName) {
      const matchingBuildings = buildings.filter(b => b.name === endName);
      if (matchingBuildings.length === 0) { alert('Destination building not found.'); return; }

      // Choose closest building instance if there are duplicates with same name
      let closestBuilding = matchingBuildings[0];
      let minDistance = Infinity;
      matchingBuildings.forEach(building => {
        const d = map.distance(L.latLng(startCoords), L.latLng(building.latitude, building.longitude));
        if (d < minDistance) { minDistance = d; closestBuilding = building; }
      });

      // Remove previous route visuals
      if (routingControl) {
        map.removeControl(routingControl);
      }
      routeMarkers.forEach(m => map.removeLayer(m));
      routeMarkers = [];

      // Create routing control
      routingControl = L.Routing.control({
        waypoints: [
          L.latLng(startCoords[0], startCoords[1]),
          L.latLng(closestBuilding.latitude, closestBuilding.longitude)
        ],
        routeWhileDragging: false,
        createMarker: function() { return null; }, // We'll add our own markers
        lineOptions: {
          styles: [{ color: '#6610F2', opacity: 0.9, weight: 6 }]
        }
      }).addTo(map);

      // Add custom markers
      const startMarker = L.marker(L.latLng(startCoords[0], startCoords[1]), {
        icon: L.divIcon({ html: 'üö∂', className: 'route-marker start-marker', iconSize: [30, 30] })
      }).bindPopup('Start Point').addTo(map);

      const endMarker = L.marker(L.latLng(closestBuilding.latitude, closestBuilding.longitude), {
        icon: L.divIcon({ html: 'üìç', className: 'route-marker end-marker', iconSize: [30, 30] })
      }).bindPopup('Destination: ' + endName).addTo(map);

      routeMarkers.push(startMarker, endMarker);

      // Get route information when routing is complete
      routingControl.on('routesfound', function(e) {
        const routes = e.routes;
        const route = routes[0];
        const totalDistance = route.summary.totalDistance; // in meters

        // fit map to route bounds
        const bounds = L.latLngBounds(route.coordinates);
        map.fitBounds(bounds.pad(0.1));

        // save history
        routeHistory.unshift({
          start: startName,
          end: endName,
          timestamp: new Date().toISOString(),
          distanceMeters: Math.round(totalDistance)
        });
        localStorage.setItem(getRouteHistoryKey(), JSON.stringify(routeHistory));
        displayHistory();
      });
    }

    function recalculateRoute(start, end) {
      document.getElementById('start-location').value = start;
      document.getElementById('end-location').value = end;
      calculateRoute();
    }

    let _showAllHistory = false;
    const HISTORY_LIMIT = 6;

    function formatKm(meters) {
      if (!meters && meters !== 0) return '';
      const km = meters / 1000;
      return km < 1 ? `${(meters/1000).toFixed(1)} km` : `${km.toFixed(1)} km`;
    }

    function estimateMinutes(meters) {
      if (!meters && meters !== 0) return '';
      // Rough walking estimate: 1 min per 100m (simple)
      const mins = Math.max(1, Math.round(meters / 100));
      return `${mins} min`;
    }

    // Function to get relative time
    function getRelativeTime(timestamp) {
      const now = new Date();
      const past = new Date(timestamp);
      const diffMs = now - past;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHour = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHour / 24);

      if (diffSec < 60) return 'Just now';
      if (diffMin < 60) return `${diffMin} minute${diffMin > 1 ? 's' : ''} ago`;
      if (diffHour < 24) return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
      return `${diffDay} day${diffDay > 1 ? 's' : ''} ago`;
    }

    function displayHistory() {
      const sectionElement = document.getElementById('recent-routes-section');
      const panelElement = document.getElementById('recent-routes');
      const footerBtn = document.getElementById('show-more-btn');
      if (!panelElement) return;

      if (!routeHistory || routeHistory.length === 0) {
        // Hide the entire section for new users with no routes
        if (sectionElement) sectionElement.style.display = 'none';
        return;
      }

      // Show the section if there are routes
      if (sectionElement) sectionElement.style.display = 'block';

      const total = routeHistory.length;
      const limit = _showAllHistory ? total : HISTORY_LIMIT;
      const toRender = routeHistory.slice(0, limit);

      let historyHTML = '';
      toRender.forEach((item, idx) => {
        const relativeTime = getRelativeTime(item.timestamp);
        const distanceMeters = item.distanceMeters || 0;
        const distanceLabel = formatKm(distanceMeters);
        const minutesLabel = estimateMinutes(distanceMeters);
        historyHTML += `<div class="history-item" onclick="recalculateRoute('${item.start}', '${item.end}')" role="button" tabindex="0" style="background: rgba(255,255,255,0.08); padding: 15px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); color: white; transition: transform 0.12s ease, box-shadow 0.12s ease; width: 100%; max-width: 300px; cursor: pointer; text-align: left; border: 1px solid rgba(255,255,255,0.1);">
                          <div class="history-top">
                            <div class="history-route">${item.start} ‚Üí ${item.end}</div>
                            <div class="history-meta"><span class="distance-badge">${distanceLabel}</span>
                            <button onclick="event.stopPropagation(); openDeleteRouteModal(${idx})" class="delete-route-btn" title="Delete this route">üóëÔ∏è</button></div>
                          </div>
                          <div class="history-details" style="white-space: nowrap;">${relativeTime}</div>
                        </div>`;
      });

      panelElement.innerHTML = historyHTML;

      // show/hide footer show-more button
      if (footerBtn) {
        if (total > HISTORY_LIMIT) {
          footerBtn.style.display = 'inline-block';
          footerBtn.textContent = _showAllHistory ? 'Show less' : `Show more (${total - HISTORY_LIMIT})`;
        } else {
          footerBtn.style.display = 'none';
        }
      }
    }

    function clearHistory() {
      if (!confirm('Clear all recent routes?')) return;
      routeHistory = [];
      localStorage.removeItem(getRouteHistoryKey());
      displayHistory();
    }

    function deleteRoute(idx) {
      routeHistory.splice(idx, 1);
      localStorage.setItem(getRouteHistoryKey(), JSON.stringify(routeHistory));
      displayHistory();
    }

    function openDeleteRouteModal(idx) {
      routeToDeleteIndex = idx;
      const modal = document.getElementById('delete-route-modal');
      modal.style.display = 'flex';
    }

    function closeDeleteRouteModal() {
      const modal = document.getElementById('delete-route-modal');
      modal.style.display = 'none';
      routeToDeleteIndex = null;
    }

    function confirmDeleteRoute() {
      if (routeToDeleteIndex !== null) {
        deleteRoute(routeToDeleteIndex);
        closeDeleteRouteModal();
      }
    }

    function toggleShowMore() {
      _showAllHistory = !_showAllHistory;
      displayHistory();
    }

    function clearRoute(resetDropdowns = true) {
      // Remove route visuals
      if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
      }
      routeMarkers.forEach(m => map.removeLayer(m));
      routeMarkers = [];

      // hide building info
      document.getElementById('building-info').style.display = 'none';

      // reset selects
      if (resetDropdowns) {
        const startSelect = document.getElementById('start-location');
        const endSelect = document.getElementById('end-location');
        endSelect.value = '';
        if (startSelect.value !== 'current') {
          startSelect.value = '';
        }
      }
    }

    function searchBuilding() {
      const searchTerm = document.getElementById('search-input').value.trim().toLowerCase();
      if (!searchTerm) { alert('Enter a building name or description.'); return; }
      const building = buildings.find(b => b.name.toLowerCase().includes(searchTerm) || (b.description && b.description.toLowerCase().includes(searchTerm)));
      if (building) {
        map.setView([building.latitude, building.longitude], 19);
        showBuildingInfo(building);
        selectedBuilding = building;
        // open corresponding marker popup
        markers.forEach(marker => {
          const pos = marker.getLatLng();
          if (Math.abs(pos.lat - building.latitude) < 1e-6 && Math.abs(pos.lng - building.longitude) < 1e-6) {
            marker.openPopup();
          }
        });
      } else {
        alert('Building not found. Please try another search term.');
      }
    }

    function getUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          const userCoords = [position.coords.latitude, position.coords.longitude];
          if (userMarker) {
            userMarker.setLatLng(userCoords);
          } else {
            userMarker = L.marker(userCoords, {
              icon: L.divIcon({ html: 'üìç', className: 'user-marker', iconSize: [30, 30] })
            }).addTo(map).bindPopup('You are here!');
          }
        }, error => {
          console.log('Geolocation not available or permission denied', error);
        });
      }
    }

    function openShareLocationModal() {
      const modal = document.getElementById('share-location-modal');
      modal.style.display = 'flex';
      loadUsers();
      // Clear search on open
      document.getElementById('user-search').value = '';
    }

    function closeShareLocationModal() {
      const modal = document.getElementById('share-location-modal');
      modal.style.display = 'none';
    }

    function closeLocationSharedSuccessModal() {
      const modal = document.getElementById('location-shared-success-modal');
      modal.style.display = 'none';
    }

    let allUsers = [];

    function loadUsers() {
      fetch('/get-users/', {
        credentials: 'same-origin'
      })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          allUsers = data.users;
          displayUsers(allUsers);
        })
        .catch(error => {
          console.error('Error loading users:', error);
          document.getElementById('users-list').innerHTML = '<p>Error loading users.</p>';
        });
    }

    function displayUsers(users) {
      const usersList = document.getElementById('users-list');
      usersList.innerHTML = '';

      if (users.length === 0) {
        usersList.innerHTML = '<p>No users found.</p>';
        return;
      }

      users.forEach(user => {
        const userDiv = document.createElement('div');
        userDiv.style.display = 'flex';
        userDiv.style.alignItems = 'center';
        userDiv.style.marginBottom = '10px';
        userDiv.style.padding = '10px';
        userDiv.style.border = '1px solid #ddd';
        userDiv.style.borderRadius = '8px';

        userDiv.innerHTML = `
          <label for="user-${user.id}" style="margin: 0; cursor: pointer; flex: 1; white-space: nowrap;">
            <strong>${user.full_name || 'No name'}</strong>
          </label>
          <input type="checkbox" id="user-${user.id}" value="${user.id}" style="margin-left: 10px;">
        `;

        usersList.appendChild(userDiv);
      });
    }

    function filterUsers() {
      const searchTerm = document.getElementById('user-search').value.toLowerCase();
      const filteredUsers = allUsers.filter(user =>
        (user.full_name || '').toLowerCase().includes(searchTerm) ||
        (user.username || '').toLowerCase().includes(searchTerm)
      );
      displayUsers(filteredUsers);
    }

    function shareLocation() {
      const selectedUsers = Array.from(document.querySelectorAll('#users-list input[type="checkbox"]:checked'))
        .map(checkbox => parseInt(checkbox.value));

      if (selectedUsers.length === 0) {
        alert('Please select at least one user to share your location with.');
        return;
      }

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          const latitude = position.coords.latitude;
          const longitude = position.coords.longitude;

          fetch('/share-location/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
              latitude: latitude,
              longitude: longitude,
              recipients: selectedUsers
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              closeShareLocationModal();
              const successModal = document.getElementById('location-shared-success-modal');
              successModal.style.display = 'flex';
            } else {
              alert('Error sharing location: ' + data.message);
            }
          })
          .catch(error => {
            console.error('Error sharing location:', error);
            alert('Error sharing location. Please try again.');
          });
        }, () => {
          alert('Unable to get your location. Please enable location services and try again.');
        });
      } else {
        alert('Geolocation is not supported by your browser.');
      }
    }

    // init on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      const clearBtn = document.getElementById('clear-history');
      if (clearBtn) clearBtn.addEventListener('click', clearHistory);
      const showMoreBtn = document.getElementById('show-more-btn');
      if (showMoreBtn) showMoreBtn.addEventListener('click', toggleShowMore);
      displayHistory();
      // Add search event listener
      const userSearch = document.getElementById('user-search');
      if (userSearch) userSearch.addEventListener('input', filterUsers);
    });
  </script>
</body>
</html>