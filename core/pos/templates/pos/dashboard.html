{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard | Uni360</title>
  <link rel="stylesheet" href="{% static 'pos/style.css' %}">
  <link rel="stylesheet" href="{% static 'pos/dashboard.css' %}">
</head>
<body>
  <div class="sidebar">
    <div>
      <h2 style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 24px;">ğŸ“</span>
        <span>Uni360</span>
      </h2>
      <a href="#" class="active">ğŸ  Dashboard</a>
      <a href="{% url 'map' %}">ğŸ—ºï¸ Campus Map</a>
      <a href="{% url 'safety' %}">ğŸ›¡ï¸ Safety</a>
      <a href="{% url 'notifications' %}">ğŸ”” Notifications</a>
    </div>
    <a href="{% url 'logout' %}" class="logout">Logout</a>
  </div>

  <!-- Top Header -->
  <div class="top-header">
    <div class="search-bar">
      <input type="text" placeholder="Search anything...">
      <button>SearchğŸ”</button>
    </div>
    <div class="profile-menu">
      <a href="{% url 'profile' %}">
        <img src="{% if user.profile.profile_picture_data %}{{ user.profile.profile_picture_data }}{% else %}{% static 'pos/default-profile.jpg' %}{% endif %}" alt="User Profile Image" class="profile-icon" role="button" tabindex="0" aria-label="Go to profile">
      </a>
    </div>
  </div>

  <div class="content">
    <h1>Welcome, {{ request.user.profile.full_name }} ğŸ‘‹</h1>
    <p>This is your Uni360 POS Dashboard.</p>

    <!-- Locations Section -->
    <div style="margin-top: 30px;">
      <h2>Campus Locations ğŸ“</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
        <!-- GLE Building -->
        <div class="location-card" style="background: rgba(255,255,255,0.9); color: #333; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <img src="" alt="GLE Building Photo" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px; background: #f0f0f0;">
          <h3>GLE Building</h3>
          <p>General Education Building</p>
        </div>
        <!-- Library -->
        <div class="location-card" style="background: rgba(255,255,255,0.9); color: #333; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <img src="" alt="Library Photo" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px; background: #f0f0f0;">
          <h3>Library</h3>
          <p>Main campus library with study areas</p>
        </div>
        <!-- Parking -->
        <div class="location-card" style="background: rgba(255,255,255,0.9); color: #333; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <img src="" alt="Parking Photo" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px; background: #f0f0f0;">
          <h3>Parking</h3>
          <p>Student and faculty parking areas</p>
        </div>
        <!-- Gymnasium -->
        <div class="location-card" style="background: rgba(255,255,255,0.9); color: #333; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <img src="" alt="Gymnasium Photo" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px; background: #f0f0f0;">
          <h3>Gymnasium</h3>
          <p>Sports facilities and gym</p>
        </div>
        <!-- Main Canteen -->
        <div class="location-card" style="background: rgba(255,255,255,0.9); color: #333; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <img src="" alt="Main Canteen Photo" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px; background: #f0f0f0;">
          <h3>Main Canteen</h3>
          <p>Cafeteria and student activities</p>
        </div>
        <!-- NGE Building -->
        <div class="location-card" style="background: rgba(255,255,255,0.9); color: #333; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <img src="" alt="NGE Building Photo" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px; background: #f0f0f0;">
          <h3>NGE Building</h3>
          <p>Administration and main classrooms</p>
        </div>
      </div>
 
      <!-- Recent Routes Section -->
      <div style="margin-top: 30px;">
        <h2>Recent Routes ğŸ—ºï¸</h2>
        <div id="recent-routes" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;">
          <!-- Routes will be loaded here -->
        </div>
      </div>
 
    </div>
  </div>

  <script>
    // Function to get relative time
    function getRelativeTime(timestamp) {
      const now = new Date();
      const past = new Date(timestamp);
      const diffMs = now - past;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHour = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHour / 24);

      if (diffSec < 60) return 'Just now';
      if (diffMin < 60) return `${diffMin} minute${diffMin > 1 ? 's' : ''} ago`;
      if (diffHour < 24) return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
      return `${diffDay} day${diffDay > 1 ? 's' : ''} ago`;
    }

    // Load and display recent routes
    function loadRecentRoutes() {
      const history = JSON.parse(localStorage.getItem('routeHistory')) || [];
      const container = document.getElementById('recent-routes');

      if (history.length === 0) {
        container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #666;">No recent routes yet. Visit the map to start navigating!</p>';
        return;
      }

      container.innerHTML = history.slice(0, 6).map(item => {
        const distanceKm = (item.distanceMeters / 1000).toFixed(1);
        const relativeTime = getRelativeTime(item.timestamp);
        return `
          <div class="route-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.2s;" onclick="goToRoute('${item.start}', '${item.end}')">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <h3 style="margin: 0; font-size: 18px;">${item.start} â†’ ${item.end}</h3>
              <span style="background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 20px; font-size: 12px;">${relativeTime}</span>
            </div>
            <p style="margin: 0; opacity: 0.9;">${distanceKm} km â€¢ Click to navigate</p>
          </div>
        `;
      }).join('');
    }

    function goToRoute(start, end) {
      localStorage.setItem('selectedRoute', JSON.stringify({start, end}));
      window.location.href = '{% url "map" %}';
    }

    // Load routes on page load
    window.onload = function() {
      loadRecentRoutes();
    };

    // Safety Alert Button Functionality
    const safetyBtn = document.getElementById('safety-alert-btn');
    const alertForm = document.getElementById('alert-form');
    const cancelBtn = document.getElementById('cancel-alert');
    const form = document.getElementById('alert-form-element');

    safetyBtn.addEventListener('click', () => {
      alertForm.style.display = 'block';
    });

    cancelBtn.addEventListener('click', () => {
      alertForm.style.display = 'none';
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const formData = new FormData(form);

      fetch('{% url "send_alert" %}', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          alertForm.style.display = 'none';
          form.reset();
        } else {
          alert('Error: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while sending the alert.');
      });
    });
  </script>


</body>
</html>
