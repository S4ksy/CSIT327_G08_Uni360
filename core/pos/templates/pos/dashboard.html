{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard | Uni360</title>
  <link rel="stylesheet" href="{% static 'pos/style.css' %}">
  <link rel="stylesheet" href="{% static 'pos/dashboard.css' %}">
  <link rel="stylesheet" href="{% static 'pos/map.css' %}">
</head>
<body>
<div class="sidebar">
  <div>
    <h2 style="display: flex; align-items: center; gap: 10px;">
      <span style="font-size: 24px;">üéì</span>
      <span>Uni360</span>
    </h2>
    <div class="user-profile">
      <img src="{% if user.profile.profile_picture_data %}{{ user.profile.profile_picture_data }}{% else %}{% static 'pos/default-profile.jpg' %}{% endif %}" alt="Profile Picture" class="sidebar-profile-pic" style="width: 40px !important; height: 40px !important; max-width: 40px !important; max-height: 40px !important; object-fit: cover !important;">
      <span class="user-name">{{ request.user.profile.full_name|default:request.user.username }}</span>
    </div>
    <a href="#" class="active">Dashboard</a>
      <a href="{% url 'map' %}">Campus Map</a>
      <a href="{% url 'safety' %}">Safety</a>
      <a href="{% url 'notifications' %}">Notifications</a>
      <a href="{% url 'profile' %}">Profile</a>
    </div>
    <a href="{% url 'logout' %}" class="logout">Logout</a>
  </div>


  <div class="content">
    <h1>Welcome, {{ request.user.profile.full_name }} üëã</h1>
    <p>This is your Uni360 POS Dashboard.</p>

    <!-- Locations Section -->
    <div style="margin-top: 30px;">
      <h2>Campus Locations üìç</h2>
      <div style="display: grid; grid-template-columns: repeat(5, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
        <!-- GLE Building -->
        <div class="location-card" onclick="showModal('GLE Building')" style="background: rgba(255,255,255,0.9); color: #333; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <img src="{% static 'pos/GLE building.jfif' %}" alt="GLE Building Photo" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px;">
          <h3>GLE Building</h3>
        </div>
        <!-- Library -->
        <div class="location-card" onclick="showModal('Library')" style="background: rgba(255,255,255,0.9); color: #333; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <img src="{% static 'pos/Library.jfif' %}" alt="Library Photo" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px;">
          <h3>Library</h3>
        </div>
        <!-- Parking -->
        <div class="location-card" onclick="showModal('Parking')" style="background: rgba(255,255,255,0.9); color: #333; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <div class="image-gallery">
            <img src="{% static 'pos/Espacio Parking.jfif' %}" alt="Parking">
            <img src="{% static 'pos/GLE parking.jfif' %}" alt="Parking">
            <img src="{% static 'pos/NGE parking.jfif' %}" alt="Parking">
            <img src="{% static 'pos/NGE parking2.jfif' %}" alt="Parking">
            <img src="{% static 'pos/RTL Parking.jfif' %}" alt="Parking">
            <img src="{% static 'pos/RTL parking2.jfif' %}" alt="Parking">
          </div>
          <h3>Parking</h3>
        </div>
        <!-- Gymnasium -->
        <div class="location-card" onclick="showModal('Gymnasium')" style="background: rgba(255,255,255,0.9); color: #333; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <img src="{% static 'pos/GYM.jfif' %}" alt="Gymnasium Photo" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px;">
          <h3>Gymnasium</h3>
        </div>
        <!-- Main Canteen -->
        <div class="location-card" onclick="showModal('Main Canteen')" style="background: rgba(255,255,255,0.9); color: #333; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <div class="image-gallery">
            <img src="{% static 'pos/GYM canteen.jfif' %}" alt="Canteen">
            <img src="{% static 'pos/GYM canteen view.jfif' %}" alt="Canteen">
            <img src="{% static 'pos/Main canteen.jfif' %}" alt="Canteen">
            <img src="{% static 'pos/Main canteen view.jfif' %}" alt="Canteen">
          </div>
          <h3>Main Canteen</h3>
        </div>
        <!-- NGE Building -->
        <div class="location-card" onclick="showModal('NGE Building')" style="background: rgba(255,255,255,0.9); color: #333; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <img src="{% static 'pos/NGE main building.jfif' %}" alt="NGE Building Photo" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px;">
          <h3>NGE Building</h3>
        </div>
        <!-- ACAD Building -->
        <div class="location-card" onclick="showModal('ACAD Building')" style="background: rgba(255,255,255,0.9); color: #333; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <img src="{% static 'pos/ACAD building.jfif' %}" alt="ACAD Building Photo" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px;">
          <h3>ACAD Building</h3>
        </div>
        <!-- Allied Building -->
        <div class="location-card" onclick="showModal('Allied Building')" style="background: rgba(255,255,255,0.9); color: #333; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <img src="{% static 'pos/ALLIED 2.jfif' %}" alt="Allied Building Photo" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px;">
          <h3>ALLIED Building</h3>
        </div>
        <!-- RTL Building -->
        <div class="location-card" onclick="showModal('RTL Building')" style="background: rgba(255,255,255,0.9); color: #333; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <img src="{% static 'pos/RTL building.jfif' %}" alt="RTL Building Photo" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px;">
          <h3>RTL Building</h3>
        </div>
        <!-- SAL Building -->
        <div class="location-card" onclick="showModal('SAL Building')" style="background: rgba(255,255,255,0.9); color: #333; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <img src="{% static 'pos/SAL Building.webp' %}" alt="SAL Building Photo" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px;">
          <h3>SAL Building</h3>
        </div>
      </div>
 
      <!-- Recent Routes Section -->
      <div style="margin-top: 30px;">
        <h2>Recent Routes üó∫Ô∏è</h2>
        <div id="recent-routes" style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: flex-start; margin-left: 0; margin-right: auto; margin-top: 20px;">
          <!-- Routes will be loaded here -->
        </div>
      </div>
 
    </div>
  </div>

  <script>
   // Current user info
   const currentUserId = "{{ request.user.id }}";
   const currentUsername = "{{ request.user.username }}";

   // Helper functions to get user-specific localStorage keys
   function getRouteHistoryKey() {
     return `routeHistory_${currentUserId}`;
   }

   function getSelectedRouteKey() {
     return `selectedRoute_${currentUserId}`;
   }

   // Function to get relative time
    function getRelativeTime(timestamp) {
      const now = new Date();
      const past = new Date(timestamp);
      const diffMs = now - past;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHour = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHour / 24);

      if (diffSec < 60) return 'Just now';
      if (diffMin < 60) return `${diffMin} minute${diffMin > 1 ? 's' : ''} ago`;
      if (diffHour < 24) return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
      return `${diffDay} day${diffDay > 1 ? 's' : ''} ago`;
    }

    // Load and display recent routes
    function loadRecentRoutes() {
      const history = JSON.parse(localStorage.getItem(getRouteHistoryKey())) || [];
      const container = document.getElementById('recent-routes');

      if (history.length === 0) {
        container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #666;">No recent routes yet. Visit the map to start navigating!</p>';
        return;
      }

      container.innerHTML = history.slice(0, 6).map(item => {
        const distanceKm = (item.distanceMeters / 1000).toFixed(1);
        const relativeTime = getRelativeTime(item.timestamp);
        return `
          <div class="route-card" style="background: rgba(255,255,255,0.08); padding: 15px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); color: white; transition: transform 0.12s ease, box-shadow 0.12s ease; width: 100%; max-width: 300px; cursor: pointer; text-align: left; border: 1px solid rgba(255,255,255,0.1);" onclick="goToRoute('${item.start}', '${item.end}')">
            <div class="history-top">
              <div class="history-route">${item.start} ‚Üí ${item.end}</div>
              <div class="history-meta"><span class="distance-badge">${distanceKm} km</span></div>
            </div>
            <div class="history-details" style="white-space: nowrap;">${relativeTime}</div>
          </div>
        `;
      }).join('');
    }

    function goToRoute(start, end) {
      localStorage.setItem(getSelectedRouteKey(), JSON.stringify({start, end}));
      window.location.href = '{% url "map" %}';
    }

    // Load routes on page load
    window.onload = function() {
      loadRecentRoutes();
    };
  </script>

  <!-- Location Modal -->
  <div id="location-modal" class="modal">
    <div class="modal-content">
      <h3 id="modal-title"></h3>
      <div id="modal-body" class="modal-body"></div>
      <div class="modal-buttons">
        <button id="get-direction-btn" onclick="getDirection()">Get Direction</button>
        <button onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Image Viewer Modal -->
  <div id="image-viewer-modal" class="modal">
    <div class="image-viewer-content">
      <span class="close-viewer" onclick="closeImageViewer()">&times;</span>
      <img id="viewer-image" src="" alt="Full Size Image">
    </div>
  </div>

  <script>
    let selectedLocation = '';
    let modalState = 'main';
    let parentLocation = '';

    const locationImages = {
      'GLE Building': ['{% static "pos/GLE building.jfif" %}', '{% static "pos/GLE view.jfif" %}'],
      'Library': ['{% static "pos/Library.jfif" %}', '{% static "pos/Library view.jfif" %}'],
      'Gymnasium': ['{% static "pos/GYM.jfif" %}', '{% static "pos/GYM view.jfif" %}'],
      'NGE Building': ['{% static "pos/NGE main building.jfif" %}', '{% static "pos/NGE view.jfif" %}'],
      'ACAD Building': ['{% static "pos/ACAD building.jfif" %}', '{% static "pos/ACAD view.jfif" %}'],
      'Allied Building': ['{% static "pos/ALLIED 2.jfif" %}', '{% static "pos/ALLIED 3.jfif" %}'],
      'RTL Building': ['{% static "pos/RTL building.jfif" %}', '{% static "pos/RTL view.jfif" %}'],
      'SAL Building': ['{% static "pos/SAL Building.webp" %}', '{% static "pos/SAL view.jfif" %}']
    };

    const parkingImages = {
      'Espacio Parking': '{% static "pos/Espacio Parking.jfif" %}',
      'GLE Parking': '{% static "pos/GLE parking.jfif" %}',
      'NGE Parking': ['{% static "pos/NGE parking.jfif" %}', '{% static "pos/NGE parking2.jfif" %}'],
      'RTL Parking': ['{% static "pos/RTL Parking.jfif" %}', '{% static "pos/RTL parking2.jfif" %}']
    };

    const canteenImages = {
      'GYM Canteen': ['{% static "pos/GYM canteen.jfif" %}', '{% static "pos/GYM canteen view.jfif" %}'],
      'Main Canteen': ['{% static "pos/Main canteen.jfif" %}', '{% static "pos/Main canteen view.jfif" %}']
    };

    function showModal(location) {
      selectedLocation = location;
      document.getElementById('modal-title').innerText = location;
      const body = document.getElementById('modal-body');
      const directionBtn = document.getElementById('get-direction-btn');

      if (location === 'Parking') {
        modalState = 'list';
        parentLocation = 'Parking';
        body.innerHTML = '<p>Select a specific parking area:</p><div class="sub-options parking-grid">' +
          '<div class="sub-card" onclick="selectSubLocation(\'Espacio Parking\')"><img src="' + parkingImages['Espacio Parking'] + '" alt="Espacio Parking" style="width: 100%; height: 200px; object-fit: cover; border-radius: 5px;"><div>Espacio Parking</div></div>' +
          '<div class="sub-card" onclick="selectSubLocation(\'GLE Parking\')"><img src="' + parkingImages['GLE Parking'] + '" alt="GLE Parking" style="width: 100%; height: 200px; object-fit: cover; border-radius: 5px;"><div>GLE Parking</div></div>' +
          '<div class="sub-card" onclick="selectSubLocation(\'NGE Parking\')"><img src="' + parkingImages['NGE Parking'][0] + '" alt="NGE Parking" style="width: 100%; height: 200px; object-fit: cover; border-radius: 5px;"><div>NGE Parking</div></div>' +
          '<div class="sub-card" onclick="selectSubLocation(\'RTL Parking\')"><img src="' + parkingImages['RTL Parking'][0] + '" alt="RTL Parking" style="width: 100%; height: 200px; object-fit: cover; border-radius: 5px;"><div>RTL Parking</div></div>' +
          '</div>';
        directionBtn.style.display = 'none';
      } else if (location === 'Main Canteen') {
        modalState = 'list';
        parentLocation = 'Main Canteen';
        body.innerHTML = '<p>Select a specific canteen:</p><div class="sub-options">' +
          '<div class="sub-card" onclick="selectSubLocation(\'GYM Canteen\')"><img src="' + canteenImages['GYM Canteen'][0] + '" alt="GYM Canteen" style="width: 100%; height: 200px; object-fit: cover; border-radius: 5px;"><div>GYM Canteen</div></div>' +
          '<div class="sub-card" onclick="selectSubLocation(\'Main Canteen\')"><img src="' + canteenImages['Main Canteen'][0] + '" alt="Main Canteen" style="width: 100%; height: 200px; object-fit: cover; border-radius: 5px;"><div>Main Canteen</div></div>' +
          '</div>';
        directionBtn.style.display = 'none';
      } else {
        modalState = 'building';
        const images = locationImages[location];
        if (images && images.length > 0) {
          const imageHtml = images.map(src => '<img src="' + src + '" alt="' + location + ' Photo" onclick="showImageViewer(this.src)" style="cursor: pointer; width: 100%; max-width: 250px; height: auto; border-radius: 10px; margin: 5px;">').join('');
          body.innerHTML = '<div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">' + imageHtml + '</div>';
        } else {
          body.innerHTML = '<p>Get directions to this location.</p>';
        }
        directionBtn.style.display = 'inline-block';
      }

      document.getElementById('location-modal').style.display = 'flex';
    }

    function selectSubLocation(subLocation) {
      selectedLocation = subLocation;
      modalState = 'detail';
      document.getElementById('modal-title').innerText = subLocation;
      const body = document.getElementById('modal-body');
      const directionBtn = document.getElementById('get-direction-btn');
      const imageSrc = parkingImages[subLocation] || canteenImages[subLocation];
      if (imageSrc) {
        if (Array.isArray(imageSrc)) {
          const imageHtml = imageSrc.map(src => '<img src="' + src + '" alt="' + subLocation + ' Photo" onclick="showImageViewer(this.src)" style="cursor: pointer; width: 100%; max-width: 250px; height: auto; border-radius: 10px; margin: 5px;">').join('');
          body.innerHTML = '<div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">' + imageHtml + '</div>';
        } else {
          body.innerHTML = '<img src="' + imageSrc + '" alt="' + subLocation + ' Photo" onclick="showImageViewer(this.src)" style="cursor: pointer; width: 100%; max-width: 500px; height: auto; border-radius: 10px; display: block; margin: 0 auto;">';
        }
      } else {
        body.innerHTML = '<p>Get directions to this location.</p>';
      }
      directionBtn.style.display = 'inline-block';
    }

    function getDirection() {
      // Assuming current location is not set, just go to map with end location
      localStorage.setItem(getSelectedRouteKey(), JSON.stringify({start: 'current', end: selectedLocation}));
      window.location.href = '{% url "map" %}';
    }

    function closeModal() {
      if (modalState === 'detail') {
        showModal(parentLocation);
      } else {
        document.getElementById('location-modal').style.display = 'none';
        modalState = 'main';
        parentLocation = '';
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('location-modal');
      const viewerModal = document.getElementById('image-viewer-modal');
      if (event.target == modal) {
        closeModal();
      }
      if (event.target == viewerModal) {
        closeImageViewer();
      }
    }

    function showImageViewer(src) {
      document.getElementById('viewer-image').src = src;
      document.getElementById('image-viewer-modal').style.display = 'flex';
    }

    function closeImageViewer() {
      document.getElementById('image-viewer-modal').style.display = 'none';
    }
  </script>

</body>
</html>
